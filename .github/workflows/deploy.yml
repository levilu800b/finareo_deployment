name: Deploy Finareo Backend to VPS

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docker-compose*.yml'
      - 'nginx/**'
      - 'backend/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - backend-only
          - restart

jobs:
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üöÄ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_PRIVATE_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /opt/finareo
          
          # Pull latest changes for all repositories
          echo "üì• Pulling latest changes..."
          
          # Update deployment repo
          cd deployment && git pull origin master && cd ..
          
          # Update backend repo  
          cd backend-src && git pull origin master && cd ..
          
          # Navigate to deployment directory
          cd deployment
          
          # Backup database BEFORE deployment
          echo "üíæ Creating pre-deployment database backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p /opt/finareo/backups
          docker exec finareo-mysql mysqldump -u root -p"${{ secrets.MYSQL_ROOT_PASSWORD }}" finareo > /opt/finareo/backups/finareo_pre_deploy_${TIMESTAMP}.sql 2>/dev/null || echo "No existing database to backup"
          
          # Copy backend source
          echo "üìã Copying backend source..."
          rm -rf backend/src backend/pom.xml
          cp -r ../backend-src/src backend/
          cp ../backend-src/pom.xml backend/
          
          # Rebuild and restart services
          echo "üê≥ Rebuilding Docker services..."
          docker-compose -p finareo -f docker-compose.yml -f docker-compose.prod.yml down
          docker-compose -p finareo -f docker-compose.yml -f docker-compose.prod.yml build --no-cache backend
          docker-compose -p finareo -f docker-compose.yml -f docker-compose.prod.yml up -d
          
          # Wait for services to start
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          # Check if services are running
          echo "üîç Checking service status..."
          docker-compose -p finareo -f docker-compose.yml -f docker-compose.prod.yml ps
          
          # Health check
          echo "üè• Performing health check..."
          curl -f http://localhost:8000/api/v1/ || echo "API starting up..."
          
          # Cleanup old images
          echo "üßπ Cleaning up..."
          docker image prune -f
          
          # Backup database AFTER successful deployment
          echo "üíæ Creating post-deployment database backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          docker exec finareo-mysql mysqldump -u root -p"${{ secrets.MYSQL_ROOT_PASSWORD }}" finareo > /opt/finareo/backups/finareo_post_deploy_${TIMESTAMP}.sql
          gzip /opt/finareo/backups/finareo_post_deploy_${TIMESTAMP}.sql
          
          # Keep only last 7 days of backups
          find /opt/finareo/backups -name "*.sql*" -mtime +7 -delete
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Finareo API is now live at https://api.finareo.com"
