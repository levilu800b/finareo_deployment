name: Deploy LiveLens to Hostinger VPS

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Hostinger VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_PRIVATE_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /opt/livelens
          
          # Pull latest changes for all repositories
          echo "ğŸ“¥ Pulling latest changes..."
          
          # Update deployment repo
          cd livelens_deployment && git pull origin master && cd ..
          
          # Update backend repo  
          cd LiveLens_Backend && git pull origin master && cd ..
          
          # Update frontend repo
          cd LiveLens_UI && git pull origin master && cd ..
          
                    # Navigate to deployment directory
          cd livelens_deployment
          
          # Rebuild and restart services
          echo "ğŸ³ Rebuilding Docker services..."
          docker-compose -f docker-compose.hostinger.yml --env-file .env.production down
          docker-compose -f docker-compose.hostinger.yml --env-file .env.production build --no-cache
          docker-compose -f docker-compose.hostinger.yml --env-file .env.production up -d
          
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Check if services are running
          echo "ğŸ” Checking service status..."
          docker-compose -f docker-compose.hostinger.yml --env-file .env.production ps
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          timeout 60 bash -c 'while ! curl -f https://livelens.space/health/ >/dev/null 2>&1; do sleep 5; done'
          
          # Verify SEO endpoints are working
          echo "ğŸ•·ï¸ Verifying SEO endpoints..."
          sleep 10
          curl -I https://livelens.space/sitemap.xml || echo "Sitemap will be available shortly"
          curl -I https://livelens.space/robots.txt || echo "Robots.txt will be available shortly"
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ LiveLens is now live at https://livelens.space"
