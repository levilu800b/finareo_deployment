name: Deploy Finareo Backend to VPS

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docker-compose*.yml'
      - 'nginx/**'
      - 'backend/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - backend-only
          - restart

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_PRIVATE_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /opt/finareo
          
          # Pull latest changes for all repositories
          echo "ğŸ“¥ Pulling latest changes..."
          
          # Update deployment repo
          cd deployment && git pull origin master && cd ..
          
          # Update backend repo  
          cd backend-src && git pull origin master && cd ..
          
          # Navigate to deployment directory
          cd deployment
          
          # Copy backend source
          echo "ğŸ“‹ Copying backend source..."
          rm -rf backend/src backend/pom.xml
          cp -r ../backend-src/src backend/
          cp ../backend-src/pom.xml backend/
          
          # Rebuild and restart services
          echo "ğŸ³ Rebuilding Docker services..."
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache backend
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
          
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Check if services are running
          echo "ğŸ” Checking service status..."
          docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          curl -f http://localhost:8000/api/v1/ || echo "API starting up..."
          
          # Cleanup old images
          echo "ğŸ§¹ Cleaning up..."
          docker image prune -f
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Finareo API is now live at https://api.finareo.com"
